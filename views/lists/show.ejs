<%- include ("../partials/header"); %>

<script>
    var listId = '<%- (list._id) %>';
</script>

<% var statusOptions = 
[ { id: "next-up", name: "Next Up" }, 
{ id: "in-progress", name: "In Progress" },               
{ id: "complete", name: "Complete" } ]; %>

<% var priorityOptions = 
[ { id: "high",    name: "High" }, 
{ id: "medium",  name: "Medium" },               
{ id: "low",     name: "Low" } ]; %>

<div class="container">

    <!-- list overview -->
    <div class="row list-overview mt-3 mb-4">

        <!-- breadcrumb: list name and href to all lists -->
        <nav aria-label="breadcrumb" class="col-sm-7" id="list-overview-nav">
            <ol class="breadcrumb my-0 align-items-center">
                <li class="breadcrumb-item"> <a href="/lists"> My Lists </a> </li>
                <li class="breadcrumb-item active" aria-current="page">
                    <p class="list-title my-0" data-editable><%= list.name %></p>
                </li>
            </ol>
        </nav>

        <div class="col-sm-5 d-flex justify-content-end align-self-center" id="list-overview-buttons">

            <!-- add task button -->
            <a class="btn btn-xs btn-primary mx-2" href="/lists/<%= list._id %>/tasks/new">New Task</a>

            <!-- delete list button -->
            <form class="delete-form" action="/lists/<%= list._id %>?_method=DELETE" method="POST">
                <button class="btn btn-xs btn-dark mx-2">Delete List</button>
            </form>

        </div>

    </div>

    <!-- list tasks -->
    <div class="row row-cols-1 row-cols-md-3">

        <% statusOptions.forEach(function(status){ %>

        <div class="col" id="<%= status.id %>-col">

            <div class="d-flex flex-row my-2">

                <!-- title of column: "statusOptions" -->
                <div>
                    <p class="py-2 px-3 my-0 status-btn-title status-btn-<%= status.id %>">
                        <%= status.name %>
                    </p>
                </div>

                <!-- num of tasks in column -->
                <div class="status-<%= status.id %>-number">
                    <p class="status-btn-number">
                        <%= 
                        list.tasks.filter(function(task){ 
                            return task.status === status.name;
                        }).length;
                        %>
                    </p>
                </div>

                <!-- add task "+" buttom (to the specific column) -->
                <div class="ml-auto">
                    <form action="/lists/<%= list._id %>/tasks/new_task" method="POST">
                        <input type="hidden" name="status" value="<%= status.id %>">
                        <button type="submit" class="btn btn-sm status-btn-plus" data-toggle="tooltip"
                            data-placement="top" title="Create new task">
                            <i class="fas fa-plus"></i>
                        </button>
                    </form>
                </div>

            </div>

            <!-- task -->
            <% list.tasks.forEach(function(task){ %>
            <% if (task.status === status.name) { %>
            <div class="card mb-3" id="<%=task._id %>" data-current-status="<%= status.id %>">
                <div class="card-body">

                    <h5 class="card-title">

                        <!-- edit/delete task buttons -->
                        <div class="flex-column float-right">

                            <!-- edit task button -->
                            <a class="btn btn-md align-top pt-0 pb-2 px-0 front-link"
                                href="/lists/<%=list._id %>/tasks/<%=task._id %>/edit" data-toggle="tooltip"
                                data-placement="right" title="Edit task">
                                <i class="fas fa-edit"></i>
                            </a>

                            <!-- delete task button -->
                            <form class="delete-form" action="/lists/<%=list._id %>/tasks/<%=task._id %>?_method=DELETE"
                                method="POST">
                                <button type="submit" class="btn btn-md pt-0 pb-2 px-0 front-link" data-toggle="tooltip"
                                    data-placement="right" title="Delete task">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>

                            <!-- change status of task button -->
                            <div data-toggle="tooltip" data-placement="right" title="Change task status">
                                <div class="dropdown">
                                    <button class="btn btn-md pt-0 pb-2 px-0" type="button"
                                        id="change-status-dropdown-button" aria-haspopup="true" aria-expanded="false"
                                        data-toggle="dropdown">
                                        <i class="fas fa-exchange-alt"></i>
                                    </button>
                                    <div class="dropdown-menu m-0" aria-labelledby="change-status-dropdown-button">
                                        <% statusOptions.forEach(function(selected_status){ %>
                                        <button type="submit"
                                            class="btn btn-sm status-btn-title status-btn-<%= selected_status.id %>"
                                            data-task-id="<%= task._id %>"
                                            data-selected-status="<%= selected_status.id %>">
                                            <%= selected_status.name %>
                                        </button>
                                        <% }) %>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- task title -->
                        <div class="task-title">
                            <a href="/lists/<%=list._id %>/tasks/<%=task._id %>">
                                <%= task.title %>
                            </a>
                        </div>

                    </h5>

                    <!-- task priority -->
                    <p class="card-text my-2 px-2 priority <%= task.priority %>" data-toggle="tooltip"
                        data-placement="right" title="Priority">
                        <%= task.priority %>
                        <% if (task.priority == "High") { %>
                        <i class="fas fa-burn" style="color: red"></i>
                        <% } %>
                    </p>

                    <!-- task due date -->
                    <% if (task.dueDate != "") { %>
                    <p class="card-text due-date my-2 px-1" data-toggle="tooltip" data-placement="right"
                        title="Due date">
                        <i class="far fa-calendar-alt mr-1"></i>
                        <%= task.dueDate %>
                    </p>
                    <% } %>

                </div>

            </div>
            <% } %>
            <% }) %>

        </div>
        <% }) %>
    </div>

</div>

<%- include ("../partials/footer"); %>